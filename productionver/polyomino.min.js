function rFloat(e){return Math.random()*e}function rInt(e){return Math.floor(Math.random()*e)}function rgb(e,t,n){gfx.fillStyle="rgb("+Math.floor(255*e)+","+Math.floor(255*t)+","+Math.floor(255*n)+")"}function hsv(e,t,n){var r,i,s,o,u,a,f,l;if(e&&t===undefined&&n===undefined)t=e.s,n=e.v,e=e.h;o=Math.floor(e*6);u=e*6-o;a=n*(1-t);f=n*(1-u*t);l=n*(1-(1-u)*t);switch(o%6){case 0:r=n,i=l,s=a;break;case 1:r=f,i=n,s=a;break;case 2:r=a,i=n,s=l;break;case 3:r=a,i=f,s=n;break;case 4:r=l,i=a,s=n;break;case 5:r=n,i=a,s=f;break}gfx.fillStyle="rgb("+Math.floor(255*r)+","+Math.floor(255*i)+","+Math.floor(255*s)+")"}function renderRect(e,t,n,r){gfx.beginPath();gfx.moveTo(e,t);gfx.lineTo(e,r);gfx.lineTo(n,r);gfx.lineTo(n,t);gfx.fill()}function newId(){return++blockId}function movePiece(e,t,n,r,i){for(var s=0;s<e.size;++s)for(var o=0;o<e.size;++o){var u=e.getCell(s+r,o+i);if(!u||!u.occupied)continue;if(u.id!==n)continue;t.getCell(s,o).quickSet(true,u.id,u.order);e.getCell(s+r,o+i).occupied=false}}function deselectGrid(e){for(var t=0;t<e.size;++t)for(var n=0;n<e.size;++n){var r=e.getCell(t,n);if(r.selected)r.selected=r.locked=false}}function keyframe(e){return keyframeSpeed*e}function processInactiveEvents(){var e=inactiveEvtLs.filter(function(e){return e.startTick<=tick});inactiveEvtLs=inactiveEvtLs.filter(function(e){return e.startTick>tick});activeEvtLs=activeEvtLs.concat(e);if(activeEvtLs.length>0)currentlyAnimating=true}function processActiveEvents(){var e=activeEvtLs.filter(function(e){return e.endTick<=tick});for(t in e)if(e[t].onEnd)e[t].onEnd();activeEvtLs=activeEvtLs.filter(function(e){return e.endTick>tick});for(evt in activeEvtLs){var t=activeEvtLs[evt];if(!t.func)continue;t.func((tick-t.startTick)/(t.endTick-t.startTick))}if(!dragging)saveGame();checkGameOver()}function orderChangeEvt(e,t,n,r,i){e.locked=true;new_event(r,i,function(r){e.order=(n-t)*r+t},function(){e.order=n})}function unlockEvt(e,t){e.locked=true;new_event(t,t,null,function(){e.locked=false;triggerDetectSquares=true})}function quickSetEvt(e,t,n,r,i){e.locked=true;new_event(i,i,null,function(){e.quickSet(t,n,r)})}function beginSurroundEvt(e,t,n,r,i){addEffect(new squareEffect(e*cellSize,t*cellSize,n*cellSize));new_event(r,i,function(r){var i=r*r*r*n*cellSize+6;rgb(1,1,1);renderRect(e*cellSize-3,(t+n)*cellSize+3-i,e*cellSize-1,(t+n)*cellSize+3);renderRect(e*cellSize-3,t*cellSize-3,e*cellSize-3+i,t*cellSize-1);renderRect((e+n)*cellSize+3,t*cellSize-3,(e+n)*cellSize+1,t*cellSize-3+i);renderRect((e+n)*cellSize+3-i,(t+n)*cellSize+3,(e+n)*cellSize+3,(t+n)*cellSize+1)},null)}function surroundEvt(e,t,n,r,i){new_event(r,i,function(r){rgb(1,1,1);renderRect(e*cellSize-3,t*cellSize-3,e*cellSize-1,(t+n)*cellSize+3);renderRect(e*cellSize-3,t*cellSize-3,(e+n)*cellSize+3,t*cellSize-1);renderRect((e+n)*cellSize+3,t*cellSize-3,(e+n)*cellSize+1,(t+n)*cellSize+3);renderRect(e*cellSize-3,(t+n)*cellSize+3,(e+n)*cellSize+3,(t+n)*cellSize+1)},null)}function highlightEvt(e,t,n,r){new_event(n,r,function(){rgb(1,1,1);renderRect(e*cellSize,t*cellSize,(e+1)*cellSize,(t+1)*cellSize)},null)}function fadeOutEvt(e,t,n,r){new_event(n,r,function(n){gfx.fillStyle="rgba(255,255,255,"+(1-n)+")";renderRect(e*cellSize,t*cellSize,(e+1)*cellSize,(t+1)*cellSize)},null)}function addScoreEvt(e){new_event(0,10,null,function(){addToScore(e)});if(scoreTick===tick)scoreCombo++;else scoreCombo=1}function gameWonEvt(){new_event(0,10,null,function(){location="#gameWon"})}function recurse(e,t,n,r,i){var s=board.getCell(t,n);if(!s||!s.occupied||s.locked)return;if(r.id!==s.id)return;if(e.getCell(t,n))return;e.setCell(t,n,true);if(i)i(s);recurse(e,t,n-1,r,i);recurse(e,t,n+1,r,i);recurse(e,t-1,n,r,i);recurse(e,t+1,n,r,i)}function checkGameOver(){for(var e=0;e<board.size;++e)for(var t=0;t<board.size;++t)if(!board[e][t].occupied||board[e][t].locked)return;location="#gameOver"}function recalculateIds(){var e=new grid(board.size);for(var t=0;t<board.size;++t)for(var n=0;n<board.size;++n)if(!e.getCell(t,n)){var r=board.getCell(t,n);if(!r.occupied||r.locked)continue;recurse(e,t,n,r);var i=newId();for(var s=0;s<board.size;++s)for(var o=0;o<board.size;++o){var u=board.getCell(s,o);if(!u.occupied||u.locked)continue;if(u.id===r.id&&!e.getCell(s,o))u.id=i}}}function recalculateOrder(){if(!orderDecay)return;for(var e=0;e<board.size;++e)for(var t=0;t<board.size;++t){var n=board.getCell(e,t);if(!n.occupied||n.locked)continue;var r=0;recurse(new grid(board.size),e,t,n,function(e){++r});if(r===n.order)continue;recurse(new grid(board.size),e,t,n,function(e){orderChangeEvt(e,e.order,r,keyframe(0),keyframe(1));unlockEvt(e,keyframe(1))})}}function detectSquares(){var e=new grid(board.size);for(var t=0;t<e.size;++t)for(var n=0;n<e.size;++n)e.setCell(t,n,0);for(var r=0;r<board.size;++r)e:for(var i=0;i<board.size;++i){var s=board.getCell(r,i);if(!s.occupied||s.locked)continue;var o=s.order+1;var u=o;for(;Math.min(r+u,i+u)<=board.size;++u){var a=board.getCell(r,i);if(!a.occupied||a.locked||a.order!==s.order)break}if(!detectHighestOrder)u=Math.min(u,o+1);t:for(var f=o;f!=u;++f){for(var t=r;t<r+f;++t)for(var n=i;n<i+f;++n){var l=board.getCell(t,n);if(!l||!l.occupied||l.locked||l.order!==s.order)continue t}for(var t=r;t<r+f;++t)for(var n=i;n<i+f;++n)if(e.getCell(t,n)<f)e.setCell(t,n,f)}}for(var r=0;r<e.size;++r)e:for(var i=0;i<e.size;++i){var s=e.getCell(r,i);if(s<=0)continue;for(var t=r;t<r+s;++t)for(var n=i;n<i+s;++n)if(e.getCell(t,n)!=s)continue e;for(var t=r;t<r+s;++t)for(var n=i;n<i+s;++n)e.setCell(t,n,0);squareToPoly(r,i,s)}recalculateIds();recalculateOrder()}function placeNewPoly(){var e=[];for(var t=0;t<board.size;++t)for(var n=0;n<board.size;++n){var r=board.getCell(t,n);if(r&&!r.locked&&!r.occupied)e.push({cell:r,x:t,y:n})}if(e.length===0)return;var i=e[rInt(e.length)];var r=i.cell;var s=newId();var o=false;var u=rInt(4);var a=function(e,t){var n=board.getCell(e,t);if(!n||n.locked||n.occupied)return;o=true;slideInEvt[u](e,t,keyframe(1),keyframe(2));quickSetEvt(n,true,s,2,keyframe(2));fadeOutEvt(e,t,keyframe(2),keyframe(3));unlockEvt(n,keyframe(3))};switch(u){case 0:a(i.x,i.y-1);break;case 1:a(i.x,i.y+1);break;case 2:a(i.x-1,i.y);break;case 3:a(i.x+1,i.y);break}slideInEvt[u](i.x,i.y,keyframe(0),keyframe(1));if(o){quickSetEvt(r,true,s,2,keyframe(1));highlightEvt(i.x,i.y,keyframe(1),keyframe(2));fadeOutEvt(i.x,i.y,keyframe(2),keyframe(3));unlockEvt(r,keyframe(3))}else{quickSetEvt(r,true,s,1,keyframe(1));fadeOutEvt(i.x,i.y,keyframe(1),keyframe(2));unlockEvt(r,keyframe(2))}}function squareToPoly(e,t,n){addScoreEvt(n);if(n>goalOrder&&!gameWon){gameWon=true;gameWonEvt()}var r=new grid(n);for(var i=0;i<r.size;++i)for(var s=0;s<r.size;++s)r.setCell(i,s,false);for(var i=e;i<e+n;++i)for(var s=t;s<t+n;++s)board.getCell(i,s).occupied=false;var i=e+rInt(n);var s=t+rInt(n);var o=board.getCell(i,s);o.quickSet(true,newId(),n);r.setCell(i-e,s-t,true);for(var u=1;u<n;++u)while(true){i=e+rInt(n);s=t+rInt(n);var a=board.getCell(i,s);if(a.occupied)continue;var f=r.getCell(i-e,s-t-1);var l=r.getCell(i-e,s-t+1);var c=r.getCell(i-e-1,s-t);var h=r.getCell(i-e+1,s-t);if(!(f||l||c||h))continue;a.quickSet(true,o.id,n);r.setCell(i-e,s-t,true);break}var p=new grid(n+2);for(var i=0;i<p.size;++i)for(var s=0;s<p.size;++s)p.setCell(i,s,false);for(var i=0;i<n;++i)for(var s=0;s<n;++s)p.setCell(i+1,s+1,r.getCell(i,s));var d=function(e,t){var n=p.getCell(e,t);if(!(n===false))return;p.setCell(e,t,true);d(e,t-1);d(e,t+1);d(e-1,t);d(e+1,t)};d(0,0);var v=false;for(var i=0;i<p.size;++i)for(var s=0;s<p.size;++s)if(!p.getCell(i,s)){squareToPoly(e,t,n);v=true}if(v)return;for(var i=e;i<e+n;++i)for(var s=t;s<t+n;++s)if(!board.getCell(i,s).occupied){var m=polyColor[board.getCell(i,s).order].primary;new particle(i*cellSize+cellSize/2,s*cellSize+cellSize/2,0,0,750,m.r*255,m.g*255,m.b*255,1,cellSize,255,255,255,0,cellSize/10,1,0)}beginSurroundEvt(e,t,n,0,n*100);surroundEvt(e,t,n,n*100,n*100+1e3)}function getMousePos(e){var t=canvas.getBoundingClientRect();return{x:e.clientX-t.left-paneThickness,y:e.clientY-t.top-paneThickness}}function calcMouseGridVars(){downGX=Math.floor(mouseDX/cellSize);downGY=Math.floor(mouseDY/cellSize);mouseGX=Math.floor(mouse.x/cellSize);mouseGY=Math.floor(mouse.y/cellSize)}function touchHandler(e){var t=e.changedTouches,n=t[0],r="";switch(e.type){case"touchstart":r="mousedown";break;case"touchmove":r="mousemove";break;case"touchend":r="mouseup";break;default:return}var i=document.createEvent("MouseEvent");i.initMouseEvent(r,true,true,window,1,n.screenX,n.screenY,n.clientX,n.clientY,false,false,false,false,0,null);n.target.dispatchEvent(i);e.preventDefault()}function tickParticles(){for(var e=0;e<effects.length;e++){if(effects[e].makeParticle()){effects.splice(e,1);e--}}for(var t=0;t<particles.length;t++){if(particles[t].tick()){particles.splice(t,1);t--}}}function addEffect(e){effects.push(e);currentlyAnimating=true}function testParticles(e,t){for(var n=0;n<3;n++){var r=e;var i=t;var s=undefined;var o=undefined;var u=rInt(1e3)+500;var a=255;var f=255;var l=99;var c=1;var h=rInt(20);var p=255;var d=0;var v=0;var m=0;var g=rInt(20);var y=1;var b=rFloat(.0025)+.0025;new particle(r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b)}}function squareEffect(e,t,n){this.x=e;this.y=t;this.size=n;this.segment=1;this.stepsize=5;this.iter=0;var r=[{r:255,g:10,b:10},{r:255,g:255,b:60},{r:200,g:100,b:0}];this.makeParticle=function(){var e=this.iter+=this.stepsize;if(e/this.segment>=this.size){this.segment++}if(this.segment>4)return true;switch(this.segment){case 1:this.x+=this.stepsize;break;case 2:this.y+=this.stepsize;break;case 3:this.x-=this.stepsize;break;case 4:this.y-=this.stepsize;break}var t=rInt(2)+2;for(var n=0;n<t;n++){var i=r[rInt(r.length)];new particle(this.x,this.y,undefined,undefined,rInt(200)+100,i.r,i.g,i.b,1,rInt(10),i.r,i.g,i.b,1,rInt(10),1,rFloat(.0025)+.0025)}return false}}function testParticleSquare(){for(var e=100;e<200;e+=10){testParticles(100,e);testParticles(200,e);testParticles(e,100);testParticles(e,200)}}function particle(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){this.x=e;this.y=t;this.vx=n;this.vy=r;var g=.01;if(n===undefined&&r===undefined){this.vx=rFloat(g)-g/2;this.vy=rFloat(g)-g/2;var y=(rFloat(g)-g/2)/(this.vx*this.vx+this.vy*this.vy);this.vx*=y;this.vy*=y}this.lifetime=i||1e3;this.endTick=tick+this.lifetime;this.startTick=tick;this.gravity=m||0;this.startr=s;this.startg=o;this.startb=u;this.starta=a;this.endr=l;this.endg=c;this.endb=h;this.enda=p;this.r=this.startr;this.g=this.startg;this.b=this.startb;this.a=this.starta;this.startscale=f||10;this.endscale=d||this.startscale;this.scale=this.startscale;this.border=v||2;this.id=particles.length;particles[this.id]=this;currentlyAnimating=true;this.tick=function(){var e=(tick-this.startTick)/this.lifetime;this.x+=this.vx;this.y+=this.vy;this.vy+=m*elapsed;this.scale=this.startscale+(this.endscale-this.startscale)*e;this.r=this.startr+(this.endr-this.startr)*e;this.g=this.startg+(this.endg-this.startg)*e;this.b=this.startb+(this.endb-this.startb)*e;this.a=this.starta+(this.enda-this.starta)*e;gfx.fillStyle="rgba(255, 255, 255,"+this.a+")";gfx.fillRect(this.x-this.scale/2,this.y-this.scale/2,this.scale,this.scale);gfx.fillStyle="rgba("+Math.floor(this.r)+","+Math.floor(this.g)+","+Math.floor(this.b)+","+this.a+")";gfx.fillRect(this.x-this.scale/2+this.border,this.y-this.scale/2+this.border,this.scale-this.border*2,this.scale-this.border*2);currentlyAnimating=true;if(tick>=this.endTick){return true}return false}}function interpColor(e,t,n){rgb(e.r+(t.r-e.r)*n,e.g+(t.g-e.g)*n,e.b+(t.b-e.b)*n)}function renderGridRaw(e,t,n){var r=cellSize;for(var i=0;i<e.size;++i)for(var s=0;s<e.size;++s){var o=e.getCell(i,s);if(!o.occupied)continue;if(n){if(Math.floor(o.order)===0)rgb(polyColor[o.order].primary.r,polyColor[o.order].primary.g,polyColor[o.order].primary.b);else interpColor(polyColor[Math.floor(o.order)].primary,polyColor[Math.ceil(o.order)].primary,o.order%1)}else{if(Math.floor(o.order)===0)rgb(polyColor[o.order].secondary.r,polyColor[o.order].secondary.g,polyColor[o.order].secondary.b);else interpColor(polyColor[Math.floor(o.order)].secondary,polyColor[Math.ceil(o.order)].secondary,o.order%1)}renderRect(i*r+t,s*r+t,(i+1)*r-t,(s+1)*r-t);var u=e.getCell(i+1,s);if(u&&u.occupied&&u.id===o.id)renderRect((i+1)*r-t-1,s*r+t,(i+1)*r+t+1,(s+1)*r-t);var a=e.getCell(i,s+1);if(a&&a.occupied&&a.id===o.id)renderRect(i*r+t,(s+1)*r-t-1,(i+1)*r-t,(s+1)*r+t+1)}}function renderGrid(e){renderGridRaw(e,1,false);renderGridRaw(e,3,true)}function render(){requestAnimationFrame(render);var e=(new Date).getTime();elapsed=e-tick;tick=e;processInactiveEvents();if(triggerDetectSquares){detectSquares();currentlyAnimating=true}triggerDetectSquares=false;if(!currentlyAnimating)return;currentlyAnimating=false;gfx.clearRect(0,0,ww,wh);gfx.save();gfx.translate(paneThickness,paneThickness);rgb(.2,.2,.2);for(var t=1;t<board.size;++t)for(var n=1;n<board.size;++n){renderRect(t*cellSize-4,n*cellSize-1,t*cellSize+4,n*cellSize+1);renderRect(t*cellSize-1,n*cellSize-4,t*cellSize+1,n*cellSize+4)}for(var t=1;t<board.size;++t){renderRect(t*cellSize-4,-1,t*cellSize+4,1);renderRect(t*cellSize-1,-1,t*cellSize+1,4);renderRect(t*cellSize-4,gridSize*cellSize-1,t*cellSize+4,gridSize*cellSize+1);renderRect(t*cellSize-1,gridSize*cellSize-4,t*cellSize+1,gridSize*cellSize+1)}for(var n=1;n<board.size;++n){renderRect(-1,n*cellSize-1,4,n*cellSize+1);renderRect(-1,n*cellSize-4,1,n*cellSize+4);renderRect(gridSize*cellSize-4,n*cellSize-1,gridSize*cellSize+1,n*cellSize+1);renderRect(gridSize*cellSize-1,n*cellSize-4,gridSize*cellSize+1,n*cellSize+4)}renderRect(-1,-1,4,1);renderRect(-1,-1,1,4);renderRect(gridSize*cellSize-4,-1,gridSize*cellSize+1,1);renderRect(gridSize*cellSize-1,-1,gridSize*cellSize+1,4);renderRect(-1,gridSize*cellSize-4,1,gridSize*cellSize+1);renderRect(-1,gridSize*cellSize-1,4,gridSize*cellSize+1);renderRect(gridSize*cellSize-4,gridSize*cellSize-1,gridSize*cellSize+1,gridSize*cellSize+1);renderRect(gridSize*cellSize-1,gridSize*cellSize-4,gridSize*cellSize+1,gridSize*cellSize+1);rgb(.05,.05,.05);for(var t=0;t<board.size;++t)for(var n=0;n<board.size;++n)renderRect(t*cellSize+2,n*cellSize+2,(t+1)*cellSize-2,(n+1)*cellSize-2);renderGrid(board);tickParticles();processActiveEvents();if(dragging){currentlyAnimating=true;floatX+=(goalFloatX-floatX)*.3;floatY+=(goalFloatY-floatY)*.3;gfx.save();gfx.translate(-floatX,-floatY);renderGrid(floating);gfx.restore();if(snapping&&Math.abs(floatX-goalFloatX)<.5&&Math.abs(floatY-goalFloatY)<.5){movePiece(floating,board,floating.getCell(mouseDX/cellSize,mouseDY/cellSize).id,placeX,placeY);deselectGrid(board);dragging=snapping=false;triggerDetectSquares=true}}gfx.restore()}function newGame(){board=new grid(gridSize);for(var e=0;e<board.size;++e)for(var t=0;t<board.size;++t)board.setCell(e,t,new cell);blockId=0;score=0;dragging=false;snapping=false;currentlyAnimating=true;triggerDetectSquares=true;for(var e=0;e<initPieceCount;++e)placeNewPoly();updateScoreBoxes()}function gameOver(){}function loadGame(){if(bypassLoad)return false;try{if(typeof Storage!=="undefined"){var e=JSON.parse(localStorage.getItem("board"));if(!e)return false;board=new grid(gridSize);for(var t=0;t<board.size;++t)for(var n=0;n<board.size;++n){board.setCell(t,n,new cell);board[t][n].occupied=e[t][n].occupied;board[t][n].id=e[t][n].id;board[t][n].order=e[t][n].order}blockId=parseInt(localStorage.getItem("blockId"));score=parseInt(localStorage.getItem("score"));var r=parseInt(localStorage.getItem("scoreFuncVersion"));if(scoreFuncVersion===r)highScore=parseInt(localStorage.getItem("highScore"));else highScore=0;dragging=false;snapping=false;currentlyAnimating=true;triggerDetectSquares=true;return true}}catch(i){return false}return false}function saveGame(){if(typeof Storage!=="undefined"){localStorage.setItem("board",JSON.stringify(board));localStorage.setItem("blockId",blockId);localStorage.setItem("score",score);localStorage.setItem("scoreFuncVersion",scoreFuncVersion);localStorage.setItem("highScore",highScore)}}function setupInstruction(){var e="Can you reach the "+(gridSize===10?"hexomino":"pentomino")+"? (contains "+(gridSize===10?"6":"5")+" squares)";document.getElementById("inst_inner").innerHTML=e}function clearContainer(e){while(e.firstChild){e.removeChild(e.firstChild)}}function addToScore(e){score+=e*e*scoreCombo;scoreTick=tick;if(score>highScore){highScore=score}updateScoreBoxes()}function updateScoreBoxes(){document.querySelector(".highscore").textContent=highScore;document.querySelector(".score").textContent=score}detectHighestOrder=true;orderDecay=false;paneThickness=4;gridSize=10;cellSize=32;initPieceCount=4;dragSpeed=.3;hoverOffset=4;keyframeSpeed=150;goalOrder=6;cellSizeThreshold=42;var polyColor=[{primary:{r:0,g:0,b:0},secondary:{r:0,g:0,b:0}},{primary:{r:.5451,g:.549,b:.4784},secondary:{r:.38157,g:.3843,b:.33487}},{primary:{r:.5451,g:.2706,b:.0745},secondary:{r:.38157,g:.18942,b:.05214}},{primary:{r:.902,g:.6667,b:.2784},secondary:{r:.6314,g:.46668,b:.19487}},{primary:{r:.698,g:.7451,b:.2314},secondary:{r:.48859,g:.52157,b:.16197}},{primary:{r:.3412,g:.5725,b:.2667},secondary:{r:.23884,g:.40075,b:.18669}},{primary:{r:.2941,g:.4118,b:.5137},secondary:{r:.20586,g:.28825,b:.35959}},{primary:{r:.451,g:.251,b:.4431},secondary:{r:.3157,g:.1757,b:.31017}},{primary:{r:.7569,g:.4,b:.3529},secondary:{r:.52983,g:.27999,b:.24702}},{primary:{r:.9255,g:.3451,b:0},secondary:{r:.64784,g:.24157,b:0}},{primary:{r:.8196,g:.5804,b:.0471},secondary:{r:.57372,g:.40628,b:.03297}},{primary:{r:.6667,g:0,b:0},secondary:{r:.46668,g:0,b:0}},{primary:{r:.702,g:.5686,b:.4118},secondary:{r:.49139,g:.39802,b:.28825}}];var board,floating;var blockId,score;var mouse,dragging,snapping,mouseDX,mouseDY,downGX,downGY,mouseGX,mouseGY;var goalFloatX,goalFloatY,floatX,floatY,placeX,placeY;var currentlyAnimating,triggerDetectSquares;var highScore=0;var gameWon=false;var scoreTick=0;var scoreCombo=0;var canvas=document.getElementById("canvas");var gfx=canvas.getContext("2d");var tick,elapsed;var ww,wh;var cell=function(){this.locked=false;this.selected=false;this.occupied=false;this.id=0;this.order=0;this.quickSet=function(e,t,n){this.occupied=e;this.id=t;this.order=n}};var grid=function(e){var t=[];t.size=e;for(var n=0;n<e;++n){t[n]=[];for(var r=0;r<e;++r)t[n][r]=null}t.setCell=function(e,n,r){e=Math.floor(e);n=Math.floor(n);if(e<0||n<0||e>=t.size||n>=t.size)return;t[e][n]=r};t.getCell=function(e,n){e=Math.floor(e);n=Math.floor(n);if(e<0||n<0||e>=t.size||n>=t.size)return null;return t[e][n]};return t};new_event=function(e,t,n,r){inactiveEvtLs.push({startTick:tick+e,endTick:tick+t,func:n,onEnd:r})};var inactiveEvtLs=[];var activeEvtLs=[];var slideInEvt=[function(e,t,n,r){new_event(n,r,function(n){rgb(1,1,1);renderRect(e*cellSize,(t+1)*cellSize-n*cellSize,(e+1)*cellSize,(t+1)*cellSize)},null)},function(e,t,n,r){new_event(n,r,function(n){rgb(1,1,1);renderRect(e*cellSize,t*cellSize,(e+1)*cellSize,t*cellSize+n*cellSize)},null)},function(e,t,n,r){new_event(n,r,function(n){rgb(1,1,1);renderRect((e+1)*cellSize-n*cellSize,t*cellSize,(e+1)*cellSize,(t+1)*cellSize)},null)},function(e,t,n,r){new_event(n,r,function(n){rgb(1,1,1);renderRect(e*cellSize,t*cellSize,e*cellSize+n*cellSize,(t+1)*cellSize)},null)}];var cancelMove=function(){placeX=placeY=0;goalFloatX=goalFloatY=0;snapping=true};canvas.addEventListener("touchstart",touchHandler);canvas.addEventListener("touchmove",touchHandler);canvas.addEventListener("touchend",touchHandler);canvas.addEventListener("mousedown",function(e){mouse=getMousePos(e);if(dragging)return;var t=board.getCell(mouse.x/cellSize,mouse.y/cellSize);if(!t||!t.occupied||t.locked)return;for(var n=0;n<board.size;++n)for(var r=0;r<board.size;++r){var i=board.getCell(n,r);if(i.id===t.id)i.locked=i.selected=true}floating=new grid(board.size);for(var n=0;n<floating.size;++n)for(var r=0;r<floating.size;++r)floating.setCell(n,r,new cell);movePiece(board,floating,t.id,0,0);mouseDX=mouse.x;mouseDY=mouse.y;calcMouseGridVars();floatX=(downGX-mouseGX)*cellSize;floatY=(downGY-mouseGY)*cellSize;goalFloatX=floatX+hoverOffset;goalFloatY=floatY+hoverOffset;dragging=true;currentlyAnimating=true});canvas.addEventListener("mousemove",function(e){mouse=getMousePos(e);if(!dragging||snapping)return;calcMouseGridVars();goalFloatX=(downGX-mouseGX)*cellSize+hoverOffset;goalFloatY=(downGY-mouseGY)*cellSize+hoverOffset});canvas.addEventListener("mouseout",function(e){if(!dragging||snapping)return;cancelMove()});canvas.addEventListener("mouseup",function(e){mouse=getMousePos(e);if(!dragging||snapping)return;calcMouseGridVars();placeX=downGX-mouseGX;placeY=downGY-mouseGY;if(downGX==mouseGX&&downGY==mouseGY){cancelMove();return}for(var t=0;t<board.size;++t)for(var n=0;n<board.size;++n){var r=board.getCell(t,n);var i=floating.getCell(t+placeX,n+placeY);if((r.occupied||r.locked&&!r.selected)&&i&&i.occupied){cancelMove();return}}for(var t=0;t<floating.size;++t)for(var n=0;n<floating.size;++n)if(floating.getCell(t,n).occupied){var s=t-placeX,o=n-placeY;if(s<0||o<0||s>=floating.size||o>=floating.size){cancelMove();return}}deselectGrid(board);for(var t=0;t<board.size;++t)for(var n=0;n<board.size;++n){var r=board.getCell(t,n);var i=floating.getCell(t+placeX,n+placeY);if(i&&i.occupied)r.locked=r.selected=true}goalFloatX=(downGX-mouseGX)*cellSize;goalFloatY=(downGY-mouseGY)*cellSize;snapping=true;placeNewPoly()});particles=[];effects=[];var firsttime=true;window.onresize=function(){canvas.height=.75*window.innerHeight;canvas.width=canvas.height>.95*window.innerWidth?canvas.height=.95*window.innerWidth:canvas.height;ww=wh=canvas.width;if(firsttime){if((canvas.width-paneThickness*2)/gridSize<cellSizeThreshold)gridSize=8;else gridSize=10;firsttime=false;goalOrder=gridSize==10?6:5}cellSize=(canvas.width-paneThickness*2)/gridSize;currentlyAnimating=true;document.getElementById("game_div").style.margin="auto "+(window.innerWidth/2-canvas.width/2-paneThickness)+"px"};bypassLoad=false;var scoreFuncVersion=2;(function(){tick=(new Date).getTime();window.onresize();setupInstruction();if(typeof Storage!=="undefined"){var t=localStorage.getItem("visited");if(!t)location="#instructions";else location="#close";localStorage.setItem("visited",true)}if(!loadGame())newGame();updateScoreBoxes();render()})()